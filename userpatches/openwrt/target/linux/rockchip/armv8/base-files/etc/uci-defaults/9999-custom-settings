#!/bin/sh
uci -q batch <<-EOF
set system.@system[0].timezone="CST-8"
set system.@system[0].zonename="Asia/Shanghai"
delete system.ntp.server
add_list system.ntp.server="ntp1.aliyun.com"
add_list system.ntp.server="ntp.tencent.com"
add_list system.ntp.server="ntp.ntsc.ac.cn"
add_list system.ntp.server="cn.ntp.org.cn"
commit system
set wireless.radio0.disabled='0'
set wireless.radio1.disabled='0'
commit wireless
EOF

while uci -q delete https-dns-proxy.@https-dns-proxy[-1]; do :; done
uci -q batch <<-EOF
add https-dns-proxy https-dns-proxy
set https-dns-proxy.@https-dns-proxy[-1].resolver_url='https://doh.pub/dns-query'
set https-dns-proxy.@https-dns-proxy[-1].bootstrap_dns='119.29.29.29'
set https-dns-proxy.@https-dns-proxy[-1].isten_port='5053'
add https-dns-proxy https-dns-proxy
set https-dns-proxy.@https-dns-proxy[-1].resolver_url='https://dns.alidns.com/dns-query'
set https-dns-proxy.@https-dns-proxy[-1].bootstrap_dns='223.6.6.6'
set https-dns-proxy.@https-dns-proxy[-1].isten_port='5054'
commit https-dns-proxy
EOF

## set key_type to dsa resolve uhttpd crash
uci set uhttpd.defaults.key_type='dsa'

sed -i '$ a\net.netfilter.nf_conntrack_max=65535' /etc/sysctl.d/11-nf-conntrack.conf
[ -f /etc/opkg/distfeeds.conf ] && sed -i.bak 's_https\?://downloads.openwrt.org_https://mirrors.tuna.tsinghua.edu.cn/openwrt_' /etc/opkg/distfeeds.conf
[ -f /etc/apk/repositories.d/distfeeds.list ] && sed -i.bak 's_https\?://downloads.openwrt.org_https://mirrors.tuna.tsinghua.edu.cn/openwrt_' /etc/apk/repositories.d/distfeeds.list

exit 0